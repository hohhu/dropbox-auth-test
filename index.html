<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Dropbox OAuth Test</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  input { padding: 5px; width: 300px; margin-bottom: 10px; }
  button { padding: 10px 20px; margin-bottom: 20px; }
  pre { background: #f0f0f0; padding: 10px; }
</style>
</head>
<body>
<h2>Dropbox OAuth Test</h2>

<label>App Key:</label><br>
<input type="text" id="appKey" placeholder="App Key"><br>

<label>App Secret:</label><br>
<input type="text" id="appSecret" placeholder="App Secret"><br>

<label>Redirect URI:</label><br>
<input type="text" id="redirectUri" placeholder="https://your-site.github.io/dropbox-auth-test/"><br>

<button id="authBtn">認可コード取得</button>

<pre id="result"></pre>

<script>
document.getElementById("authBtn").onclick = () => {
    const APP_KEY = document.getElementById("appKey").value;
    const APP_SECRET = document.getElementById("appSecret").value;
    const REDIRECT_URI = document.getElementById("redirectUri").value;

    if (!APP_KEY || !APP_SECRET || !REDIRECT_URI) {
        alert("全て入力してください");
        return;
    }

    // 認可ページにリダイレクト
    const url = `https://www.dropbox.com/oauth2/authorize?response_type=code&client_id=${APP_KEY}&redirect_uri=${REDIRECT_URI}`;
    window.location.href = url;
};

// 認可コード取得後の処理
window.onload = async () => {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    if (!code) return;

    const APP_KEY = document.getElementById("appKey").value;
    const APP_SECRET = document.getElementById("appSecret").value;
    const REDIRECT_URI = document.getElementById("redirectUri").value;

    if (!APP_KEY || !APP_SECRET || !REDIRECT_URI) {
        document.getElementById("result").textContent = "まずキーとリダイレクトURIを入力してください";
        return;
    }

    document.getElementById("result").textContent = "アクセストークン取得中…";

    try {
        const body = new URLSearchParams({
            code,
            grant_type: "authorization_code",
            client_id: APP_KEY,
            client_secret: APP_SECRET,
            redirect_uri: REDIRECT_URI
        });

        const res = await fetch("https://api.dropbox.com/oauth2/token", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body
        });

        const data = await res.json();
        document.getElementById("result").textContent = JSON.stringify(data, null, 2);
    } catch (e) {
        document.getElementById("result").textContent = "エラー: " + e;
    }
};
</script>
</body>
</html>
