<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Dropbox OAuth Test</title>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 600px; }
  input { padding: 5px; margin: 5px 0; width: 100%; }
  button { padding: 10px 20px; margin-top: 10px; font-size: 16px; }
  pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; word-break: break-all; }
</style>
</head>
<body>
<h2>Dropbox OAuth Test</h2>

<label>App Key: <input id="appKey" type="text" placeholder="あなたのApp Key"></label>
<label>App Secret: <input id="appSecret" type="text" placeholder="あなたのApp Secret"></label>
<button id="authBtn">認可コード取得</button>

<pre id="result"></pre>
<button id="copyBtn" style="display:none;">アクセストークンをコピー</button>

<script>
const REDIRECT_URI = "https://hohhu.github.io/dropbox-auth-test/";

// 認可コード取得
document.getElementById("authBtn").onclick = () => {
    const appKey = document.getElementById("appKey").value.trim();
    if (!appKey) {
        alert("App Keyを入力してください");
        return;
    }
    const url = `https://www.dropbox.com/oauth2/authorize?response_type=code&client_id=${appKey}&redirect_uri=${REDIRECT_URI}`;
    window.location.href = url;
};

// アクセストークン取得
async function fetchToken(code, appKey, appSecret) {
    const resultEl = document.getElementById("result");
    resultEl.textContent = "アクセストークン取得中…";
    try {
        const body = new URLSearchParams({
            code,
            grant_type: "authorization_code",
            client_id: appKey,
            client_secret: appSecret,
            redirect_uri: REDIRECT_URI
        });

        const res = await fetch("https://api.dropbox.com/oauth2/token", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body
        });

        const data = await res.json();
        resultEl.textContent = JSON.stringify(data, null, 2);

        if (data.access_token) {
            const copyBtn = document.getElementById("copyBtn");
            copyBtn.style.display = "inline-block";
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(data.access_token);
                copyBtn.textContent = "コピーしました!";
            };
        }
    } catch (e) {
        resultEl.textContent = "エラー: " + e;
    }
}

// ページ読み込み時
window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (code) {
        const appKey = prompt("App Keyを入力してください");
        const appSecret = prompt("App Secretを入力してください");
        if (appKey && appSecret) {
            fetchToken(code, appKey, appSecret);
        } else {
            alert("App KeyとApp Secretが必要です");
        }
    }
};
</script>
</body>
</html>
